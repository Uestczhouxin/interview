# PHP执行流程

![](http://www.nowamagic.net/librarys/images/201109/2011_09_20_02.jpg)

1. Scanning(Lexing) ,词法分析，将PHP代码转换为语言片段(Tokens)
2. Parsing, 语法解析，将Tokens转换成简单而有意义的表达式
3. Compilation, 编译，将表达式编译成Opocdes
4. Execution，执行， 顺次执行Opcodes，每次一条，从而实现PHP脚本的功能

# PHP-FPM执行流程

php-fpm启动，执行调用扩展模块PHP_MINIT_FUNCTION

1.等待请求： worker进程阻塞在fcgi_accept_request()等待请求；

2.解析请求： fastcgi请求到达后被worker接收，然后开始接收并解析请求数据，直到request数据完全到达；

3.请求初始化： 执行php_request_startup()，此阶段会调用每个扩展的：PHP_RINIT_FUNCTION()；

4.编译、执行： 由php_execute_script()完成PHP脚本的编译、执行；

5.关闭请求： 请求完成后执行php_request_shutdown()，此阶段会调用每个扩展的：PHP_RSHUTDOWN_FUNCTION()，然后进入步骤(1)等待下一个请求。

php-fpm关闭，执行调用扩展模块PHP_MSHUTDOWN_FUNCTION()

# PHP5.6与7.0区别

## 性能

性能相差2-3倍，开启opcode性能相差近10倍

## 全面一致支持64位

## 增加函数返回值类型声明以及标量类型声明

## 增加 ?? 操作符

$a = $b ?? $c  》》 $a = isset($b) ? $b : $c

## zval结构体优化

php5之后的优化为了解决循环引用（$a[] =0;$a[] = $a）重写分配zval,引入了gc_info使得变量占到32字节，再加上开启zend内存池的情况下会给gc_info 分配8个字节的内存地址保存信息，使得之前的zval的字节从24暴涨到48字节。
php7针对zval做了优化处理，保留了value字段，类型更加丰富，但复杂的数据类型通过指针来实现，使之从48字节降到了16字节。算是做了很大的变化。

# Interface与abstract

接口和抽象类的概念不一样,可以理解为接口是对动作的抽象，抽象类是对根源的抽象。当你关注一个事物的本质的时候，用抽象类；当你关注一个操作的时候，用接口

## Interface，接口（特殊的抽象类）

### 应用场景：
1、 制定规范的时候，需要保持类方法的统一性
2、多个平级类需要去实现同样的方法，只是具体的实现方式不一样时（多态）

### 使用规范：
1、接口不能实例化
2、接口的属性必须是常量 const
3、接口的方法必须是public【默认public】，且不能有函数体
4、接口所有的方法都是抽象方法，类必须实现接口的所有方法
5、一个类可以同时实现多个接口，用逗号隔开
6、接口可以继承接口【用的少】
7、可以先继承后接口，单继承多接口

## Abstract，抽象类

### 应用场景：
抽象类中不一定都是抽象的方法，也可以有具体实现的方法，这样就可以把大家公用的方法提升到抽象类中，然后具体的方法可以留给子类自己实现（此处经典的应用，模板方法设计模式）。所以抽象类可以更好的实现代码的复用

### 注意项：
1、不能被实例化
2、抽象类中不一定都是抽象方法，抽象类可以实现部分方法

## Magic方法

``` __construct() 实例化类时自动调用。
__destruct()  类对象使用结束时自动调用。
__set()       在给未定义的属性赋值的时候调用。
__get()       调用未定义的属性时候调用。
__isset()     使用isset()或empty()函数时候会调用。
__unset()     使用unset()时候会调用。
__sleep()     使用serialize序列化时候调用。
__wakeup()    使用unserialize反序列化的时候调用。
__call()      调用一个不存在的方法的时候调用。
__callStatic()调用一个不存在的静态方法是调用。
__toString()  把对象转换成字符串的时候会调用。比如 echo。
__invoke()    当尝试把对象当方法调用时调用。
__set_state() 当使用var_export()函数时候调用。接受一个数组参数。
__clone()     当使用clone复制一个对象时候调用。
```

## PSR规范

<https://www.twle.cn/l/yufei/phppsr/php-psr-index.html>

## 基础知识

<https://segmentfault.com/a/1190000011335262>

## http访问全流程

<https://juejin.im/entry/5b44155f6fb9a04f932fdf80>

## web安全

### XSS，跨站脚本攻击

#### 简介

通常指黑客通过“HTML注入”篡改网页，插入了恶意的脚本，从而控制用户浏览器。

#### 防御

只允许用户输入我们期望的数据，对不合规数据进行过滤

过滤或移除特殊的Html标签以及标签内的事件属性

### CSRF，跨站请求伪造

#### 简介

CSRF攻击的主要目的是让用户在不知情的情况下攻击自己已登录的一个系统，类似于钓鱼。

#### 防御

验证码

token

### SQL注入攻击

#### 简介

由于程序员在编写代码的时候，没有对用户输入数据的合法性进行判断，使应用程序存在安全隐患。通过操作输入来修改服务器SQL语句达到代码执行进行攻击目的

#### 防御

检查数据类型

使用预编译语句

使用存储过程

最小权限原则

### 文件上传漏洞

#### 简介

文件上传漏洞是指用户上传了一个可执行的脚本文件，并通过此脚本文件获得了执行服务端命令的能力。

利用文件上传漏洞形成攻击，要满足如下几个条件：
1. 上传文件能够被Web容器解释执行
2. 用户能够从Web上访问这个文件
3. 用户上传文件未被安全检查、格式化、压缩等操作改变内容

#### 防御

文件上传的目录设置为不可执行
判断文件类型
使用随机数改写文件名与文件路径
单独设置文件服务器的域名